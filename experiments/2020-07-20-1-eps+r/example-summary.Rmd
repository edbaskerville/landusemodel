---
title: "Construct summary from experiment output DB"
output: html_notebook
---

```{r}
library(DBI)
library(RSQLite)
library(dplyr)
```

## Basic setup

First, connect to the database (note that we disconnect at the end of this notebook):

```{r}
db_conn <- dbConnect(SQLite(), 'db.sqlite')
```

We can take a look at the tables that are available:

```{r}
dbListTables(db_conn)
```

and look at the column names in the tables:

```{r}
dbListFields(db_conn, 'runs')
```


```{r}
dbListFields(db_conn, 'output')
```

To make queries efficient, we need to add a `run_id` index to the `output` table in the database , which allows you to query the database efficiently by that column:

```{r}
dbExecute(db_conn, 'CREATE INDEX IF NOT EXISTS output_run_id_index ON output (run_id);')
```

## Query for a list of runs 

Now, let's get a list of `run_ids`, which we'll use to construct summaries for each run

We can do this via SQL directly:

```{r}
run_ids <- dbGetQuery(
  db_conn, 'SELECT run_id FROM runs'
)$run_id
length(run_ids)
```

Or, equivalently, we can use dplyr to write the SQL for us:

```{r}
run_ids <- {
  runsTable <- tbl(db_conn, 'runs') # Create a dplyr data source from the database
  query <- runsTable %>% select(run_id) %>% arrange(run_id) # Constructs query but does not execute it
  result <- query %>% collect() # Executes the query and returns a tibble
  result$run_id
}
length(run_ids)
```

## Create a simple summary table for all runs

Here's a function to create a one-row summary of a single run:

```{r}
summarize_run <- function(run_id_) {
  # Get the parameters for this run
  params <- tbl(db_conn, 'runs') %>% filter(run_id == run_id_) %>% collect()
  # Equivalent SQL:
  # params <- dbGetQuery(db_conn, 'SELECT * FROM runs WHERE run_id = ?', params = list(run_id_))
  
  # Get the complete output for this run
  output <- tbl(db_conn, 'output') %>% filter(run_id == run_id_) %>% collect()
  # Equivalent SQL:
  # output <- dbGetQuery(db_conn, 'SELECT * FROM output WHERE run_id = ?', params = list(run_id_))
  
  # Make a stupid output summary
  output_summary <- output %>%
    summarize(H_mean = mean(H), H_sd = sd(H))
  
  # Return the parameters plus the extra rows from the summary
  bind_cols(params, output_summary)
}
```

We can try this on a single run:

```{r}
summarize_run(501)
```

And then we can do it one run at a time and collect them all into a single data frame (this will take a minute or two):

```{r}
summary <- bind_rows(lapply(run_ids, summarize_run))
```

```{r}
summary
```

We can then save this for further analysis:

```{r}
if(!file.exists('summary.sqlite')) {
  summary_conn <- dbConnect(SQLite(), 'summary.sqlite')
  dbWriteTable(summary_conn, 'summary', summary)
  dbDisconnect(summary_conn)
}
```



## Clean up

When we're done, we disconnect:

```{r}
dbDisonnect(db_conn)
```
